<!DOCTYPE html>
<title>Scroll Run!</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="mobile-web-app-capable" content="yes" />
<style>
  body {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE 10+ */
  }
  ::-webkit-scrollbar {
    display: none; /* Webkit */
  }

  * {
    box-sizing: border-box;
  }

  body {
    background: #76a53d;
    margin: 0.5rem;
  }

  .wrap {
    margin: 0 auto;
    max-width: 42rem;
    position: relative;
  }

  .track {
    background: #ab3627;
    padding: 1rem;

    font-size: 2rem;
    font-family: monospace;
    color: white;
  }

  .track .segment {
    position: relative;
    border-bottom: 5px solid white;
    display: flex;
    flex-direction: column;
    min-height: 5rem;
  }

  .d10 {
    height: 10rem;
  }

  .d100 {
    height: 100rem;
  }

  .track .label {
    font-size: 2rem;
    font-family: monospace;
    color: white;
    margin-left: auto;
    margin-top: auto;
  }

  .title {
    font-size: 5rem;
    text-align: center;
    margin-top: auto;
  }

  .menu {
    text-align: center;
    padding: 0.5rem 0;
  }

  button {
    background: none;
    border: 0;
    display: block;
    width: 100%;
    align-items: normal;
  }

  .scoreboard {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.5);
    font-family: monospace;
    font-size: 4rem;
  }

  .score {
    padding: 0.5rem;
  }

  .announcement {
    position: fixed;
    top: 15rem;
    right: 0.5rem;
    left: 0.5rem;
  }

  .bubble {
    background: #fff;
    border-radius: 0.5rem;
    padding: 1rem;
    color: black;
    font-family: sans-serif;
    font-size: 2rem;

    position: absolute;
    left: 0.25rem;
  }

  .bubble::after {
    border: 0.5rem solid transparent;
    content: "";
    height: 0;
    pointer-events: none;
    position: absolute;
    width: 0;

    border-right-color: #fff;
    right: 100%;

    top: 50%;
    transform: translateY(-50%);
  }

  .hide {
    display: none;
  }
</style>

<div class="track wrap"></div>
<div class="announcement">
  <div class="wrap"><div class="bubble">Choose your distance</div></div>
</div>

<div class="scoreboard hide">
  <div class="wrap score">
    0
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // DOM
    const trackEl = document.querySelector(".track");
    const bubbleEl = document.querySelector(".bubble");
    const scoreBoardEl = document.querySelector(".scoreboard");
    const scoreEl = document.querySelector(".score");
    const body = document.body;

    function lockScroll() {
      body.style.overflow = "hidden";
    }

    function unlockScroll() {
      body.style.overflow = "";
    }

    function showEl(el) {
      el.classList.remove("hide");
    }

    function hideEl(el) {
      el.classList.add("hide");
    }

    // render functions

    function renderMenu() {
      trackEl.innerHTML = `
                      <div class="segment">
                        <span class="title">SCROLL RUN</span>
                      </div>
                      <button class="segment d10" data-start="1000">
                        <span class="label">1k</span>
                      </button>
                      <button class="segment d10" data-start="5000">
                        <span class="label">5k</span>
                      </button>
                      <button class="segment d10" data-start="10000">
                        <span class="label">10k</span>
                      </button>
                      <button class="segment d10" data-start="21097">
                        <span class="label">21k</span>
                      </button>
                      <button class="segment d10" data-start="42195">
                        <span class="label">42k</span>
                      </button>
                    `;
    }

    function renderRun(distance) {
      let track = `
                    <div class="segment start d10">
                      <span class="title">START</span>
                    </div>
                    `;

      for (i = 0; i < distance / 100; i++) {
        let segmentDistance = (i + 1) * 100;

        if (segmentDistance > distance) {
          segmentDistance = distance;
        }

        track += `
                      <div class="segment d100">
                        <span class="label">${segmentDistance}</span>
                      </div>
                      `;
      }

      trackEl.innerHTML = track;
    }

    let count;
    let startTime;
    let time;
    let timeCounter;
    let checkpoint;

    function initRun(distance) {
      checkpoint = false;
      time = 0;
      window.scrollTo(0, 1);

      // TODO: falstart instead of lock? ;)
      lockScroll();
      renderRun(distance);
      initCountdown();
    }

    function initCountdown() {
      count = 5;

      function countdown() {
        if (count) {
          bubbleEl.innerHTML = `Start in: ${count}...`;
          count -= 1;
          setTimeout(countdown, 1000);
        } else {
          startRun();
        }
      }

      countdown();
    }

    function startRun() {
      unlockScroll();
      showEl(scoreBoardEl);
      bubbleEl.innerHTML = "Scroll!";
      startTime = Date.now();
      timeCounter = setInterval(timeTick, 1);

      window.addEventListener("scroll", scrollHandler);
    }

    function finishRun() {
      clearInterval(timeCounter);
      bubbleEl.innerHTML = `Finished in ${formatTime(time)}!`;
      window.removeEventListener("scroll", scrollHandler);
    }

    function timeTick() {
      const now = Date.now();
      time = now - startTime;
      scoreEl.innerHTML = formatTime(time);
    }

    window.addEventListener("click", function(event) {
      const target = event.target.closest("[data-start]");

      if (target) {
        if (target.dataset["start"]) {
          initRun(+target.dataset["start"]);
        }
      }
    });

    function scrollHandler() {
      if (
        window.innerHeight + window.pageYOffset >=
        document.body.offsetHeight
      ) {
        bubbleEl.innerHTML = "Scroll back!";
        checkpoint = true;
      }
      if (window.pageYOffset <= 0 && checkpoint) {
        finishRun();
      }
    }

    function formatTime(ms) {
      return `${ms / 1000}s`
    }
    renderMenu();
  });
</script>
